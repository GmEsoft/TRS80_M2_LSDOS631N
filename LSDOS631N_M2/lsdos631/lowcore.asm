;****************************************************************;* Filename: LOWCORE.ASM					*;* Rev Date: 30 Nov 97						*;* Version : 6.3.1						*;****************************************************************;* TRS-80 Model II/4 Floppy Diskette Bootstrap Code		*;****************************************************************;* This is the main file use to assemble BOOT/SYS for TRSDOS6.	*;* Assemble as a CIM file using the following command line:	*;*    MRAS LOWCORE -GC -WE -CI					*;****************************************************************;; LOWCORE/ASM - Low Memory Assignments	TITLE	<LOWCORE - LS-DOS 6.3>*GET	BUILDVER;;	LSDOS 6.x Low Core RAM storage assignments;	Copyright (c) 1982 by Logical Systems, Inc.;	IF	@GERMAN.AND.@FRENCH	ERR	'Can''t do both French and German'	ENDIF;--> GmE mod: Model 4	IF	@MOD4;<--	 IF	@GERMAN.OR.@FRENCH@INTL	  EQU	-1@USA	  EQU	0@HZ50	  EQU	-1	 ELSE@INTL	  EQU	0@USA	  EQU	-1@HZ50	  EQU	0	 ENDIF;--> GmE mod: Model II	ELSE	 IF	@MOD2	  IF	@GERMAN.OR.@FRENCH	   ERR	'Model 2: French or German not supported'	  ELSE@INTL	   EQU	0@USA	   EQU	-1@HZ50	   EQU	0	  ENDIF	 ELSE	  ERR	'@MOD4 and @MOD2 both null'	 ENDIF	ENDIF;<--;START$	EQU	0;;	These EQUs are detailed in SYSRES;FDDINT$ EQU	0EHPDRV$	EQU	1BHTIMSL$	EQU	2BHTIMER$	EQU	2CHTIME$	EQU	TIMER$+1DATE$	EQU	33HINTVC$	EQU	3EHFLGTAB$ EQU	6AHCFLAG$	EQU	FLGTAB$+'C'-'A'DFLAG$	EQU	FLGTAB$+'D'-'A'IFLAG$	EQU	FLGTAB$+'I'-'A'KFLAG$	EQU	FLGTAB$+'K'-'A'MODOUT$ EQU	FLGTAB$+'M'-'A'NFLAG$	EQU	FLGTAB$+'N'-'A'OPREG$	EQU	FLGTAB$+'O'-'A'RFLAG$	EQU	FLGTAB$+'R'-'A'SFLAG$	EQU	FLGTAB$+'S'-'A'VFLAG$	EQU	FLGTAB$+'V'-'A'@KITSK	EQU	FLGTAB$+31;	ORG	200H+START$;;	Page 2 - Device Control Blocks;BUR$	DB	00H		;Bank use RAMBAR$	DB	0FEH		;Bank available RAM;--> GmE fix Model 4	IF	@MOD4;<--LBANK$	DB	20		;Dir cyl & logical bank;--> GmE mod: Model II	ENDIF	IF	@MOD2LBANK$	DB	38		;Dir cyl & logical bank	ENDIF;<--JCLCB$	DB	1,0,0		;Mini DCB for JCL getsDVRHI$	DW	DVREND$		;Start of low I/O zoneKIDCB$	DB	5		;Permit CTL, GET	DW	KIDVR	DB	0,0,0,'KI'DODCB$	DB	7		;Permit CTL, PUT, GET	DW	DODVR	DB	0,0,0,'DO'PRDCB$	DB	6		;Permit CTL, PUT	DW	PRDVR	DB	0,0,0,'PR'SIDCB$	DB	15H		;Routed to *KI	DW	KIDCB$	DB	0DH,0,0,'SI'SODCB$	DB	17H		;Routed to *DO	DW	DODCB$	DB	0FH,0,0,'SO'JLDCB$	DB	0AH,0,0,0AH,0,0,'JL'S1DCB$	EQU	$		;1st spare DCBDCBKL$	EQU	JLDCB$&0FFH+1	;Non-killable DCBs;;	Now load the BOOT sector code;;--> GmE mod: Model 4	IF	@MOD4;<--*GET	BOOT4;--> GmE mod: Model II	ENDIF;	IF	@MOD2	DC	0300H-$,0	;Pad Page 2;	NOP			;Page 3;	CP	26H		;Directory track location 	DW	0		;Page 3	DB	26H		;Directory track location	DB	2		;?Model 2?	DC	0400H-$,0	;Pad Page 3	ENDIF;<--;	SUBTTL	'<SysInfo Section>';;	Page 3 - System stack and Sysinfo section;STACK$	EQU	$-128		;Start stack 128 bytes lowPAUSE@	EQU	STACK$+2	;Where pause will be;;	Page 4 - Miscellaneous stuff;	DB	63H		;Operating system versionZERO$	DB	0C9H		;Config on BOOT, yes = 0MAXDAY$ EQU	$-1		;Max days per month	DB	31,28,31,30,31,30,31,31,30,31,30,31HIGH$	DS	2		;Highest available memoryPAKNAM$ DB	'LS-DOS63Level-1',@DOSLVL;;	Command line input buffer & AUTO buffer area;INBUF$	DB	0DH		;Input buffer - 80 bytes	DC	79,0;;	System drive code tables;DCT$	EQU	$		;System drive code tables;--> GmE mod: Model 4	IF	@MOD4;<--	JP	FDCDVR		;Floppy drive 0	DB	44H,0C1H,0,39,17,3-1<5+6-1,20	JP	FDCDVR		;Floppy drive 1	DB	44H,42H,-1,39,17,3-1<5+6-1,20	RET	DW	FDCDVR		;Floppy drive #2	DB	44H,44H,-1,39,17,3-1<5+6-1,20	RET	DW	FDCDVR		;Floppy drive #3	DB	44H,48H,-1,39,17,3-1<5+6-1,20	RET			;Logical drive 4	DW	FDCRET	DB	0,0,0,39,0,0,0	RET			;Logical drive 5	DW	FDCRET	DB	0,0,0,39,0,0,0	RET			;Logical drive 6	DW	FDCRET	DB	0,0,0,39,0,0,0	RET			;Logical drive 7	DW	FDCRET	DB	0,0,0,39,0,0,0;--> GmE mod: Model II	ENDIF	IF	@MOD2	JP	FDCDVR		;Floppy drive 0	DB	22H,0C1H,0,76,29,3-1<5+10-1,38	;3=grans/trk; 10=sects/gran	JP	FDCDVR		;Floppy drive 1	DB	62H,42H,76,76,29,3-1<5+10-1,38	RET	DW	FDCDVR		;Floppy drive #2	DB	62H,44H,76,76,29,3-1<5+10-1,38	RET	DW	FDCDVR		;Floppy drive #3	DB	62H,48H,76,76,29,3-1<5+10-1,38	RET			;Logical drive 4	DW	FDCRET	DB	0,0,0,39,0,0,0	RET			;Logical drive 5	DW	FDCRET	DB	0,0,0,39,0,0,0	RET			;Logical drive 6	DW	FDCRET	DB	0,0,0,39,0,0,0	RET			;Logical drive 7	DW	FDCRET	DB	0,0,0,39,0,0,0	ENDIF;<--;;	SYSINFO - miscellaneous information;DSKTYP$ DB	-1		;0 = DATA, <>0 = SYS	DB	0		;ReservedDTPMT$	DB	0		;Date prompt at boot (0-Yes)TMPMT$	DB	0		;Time prompt at boot (0-Yes)RSTOR$	DB	0		;Suppress restores on boot	DB	0		;X'C5' - unknown;;	Note from Pete Cervasio about this byte:;;	Byte X'C6' of the sysinfo sector holds the backup;	limit count for backup-limited diskettes.  If this;	value is 0FFH, then BACKUP will refuse to back up;	backup-limit protected files (BIT 4 of DIR+1), which;	is documented as "file modified when date not set".;	When this byte is 1-0FEH, then that's the number of;	backups remaining.  Normal disks just have a 0 here.;	Bit 4 of GAT+X'CD' is set when a disk is a protected;	disk.  This was determined by tracing through the;	BACKUP/CMD source code.;	DB	0		;X'C6' - Backup limit count;;DAYTBL$ DB	'SunMonTueWedThuFriSat'MONTBL$ DB	'JanFebMarAprMayJunJulAugSepOctNovDec';;	End of low core assignments;*GET	IODVR			;I/O driver, KEYIN, etc.*GET	MULDIV			;16 bit MULT & DIV;--> GmE mod: Model 4	IF	@MOD4;<--*GET	CLOCKS			;Hardware task stuff;--> GmE mod: Model II	ENDIF	IF	@MOD2*GET	CLOCKS2			;Hardware task stuff (Model II)	ENDIF;<--@$SYS	EQU	$	IF	@USA;--> GmE mod: Model 4	IF	@MOD4;<--*GET	KIDVR			;Keyboard driver (Model 4);--> GmE mod: Model II	ENDIF	IF	@MOD2*GET	KIDVR2			;Keyboard driver (Model II)	ENDIF;<--	ENDIF	IF	@GERMANFREN	EQU	00GERM	EQU	-1*GET	KIDVRFG	ENDIF	IF	@FRENCHFREN	EQU	-1GERM	EQU	00*GET	KIDVRFG	ENDIF;--> GmE mod: Model 4	IF	@MOD4;<--*GET	DODVR			;Video driver;--> GmE mod: Model II	ENDIF	;@MOD4	IF	@MOD2*GET	DODVR2			;Video driver (Model II)	ENDIF;<--*GET	PRDVR			;Printer driver & filter;--> GmE mod: Model 4	IF	@MOD4;<--*GET	FDCDVR			;Floppy disk driver;--> GmE mod: Model II	ENDIF	;@MOD4	IF	@MOD2*GET	FDCDVR2			;Floppy disk driver (Model II)	ENDIF;<--DVREND$ EQU	$		;Start of low I/O area, to 12FFH	IFGT	$,1200H+START$	ERR	'Drivers overflow available RAM';--> GmE mod: Model II	ENDIF	;@MOD2;	IF	@MOD2	IF	1		;Model 2 garbage 				;(enable to match original BOOT/SYS)	DC	20H,0	DB	00H,00H,00H,0E7H,0B0H,29H,3CH,10H	DB	8DH,00H,00H,8AH,0CFH,05H,0CFH,0C3H	DB	8BH,79H,00H,00H,0B0H,29H,14H,28H	DB	85H,0E7H,8AH,0CFH,05H,0CFH,5AH,00H	DC	0E0H,0	DB	00H,00H,00H	ENDIF			;End Model 2 garbage	ENDIF	;@MOD2;<--	ORG	1300H+START$@BYTEIO EQU	$	END	END